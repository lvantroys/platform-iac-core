name: Terraform Drift (platform-iac-core)

on:
  schedule:
    - cron: "0 6 * * 1" # Mondays 06:00 UTC
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  enumerate:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: set-matrix
        shell: bash
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY#*/}"

          declare -A stacks=()
          while IFS= read -r p; do stacks["$(dirname "$p")"]=1; done < <(find live -name backend.hcl.example -print)

          json='['
          first=1
          for stack in $(printf "%s\n" "${!stacks[@]}" | sort); do
            env_name="$(echo "$stack" | awk -F/ '{print $2}')"
            stack_rel="${stack#live/}"
            state_key="${repo}/${stack_rel}/terraform.tfstate"
            role_arn="arn:aws:iam::${AWS_ACCOUNT_ID}:role/gha-${repo}-${env_name}-plan"

            [[ $first -eq 0 ]] && json+=','
            first=0
            json+="{\"stack_path\":\"$stack\",\"environment\":\"$env_name\",\"state_key\":\"$state_key\",\"role_arn\":\"$role_arn\"}"
          done
          json+=']'
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  drift:
    needs: [enumerate]
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.enumerate.outputs.matrix) }}

    uses: lvantroys/platform-reusable-wf-infra/.github/workflows/terraform-plan.yml@v3
    permissions:
      id-token: write
      contents: read
    with:
      stack_path: ${{ matrix.stack_path }}
      environment: ${{ matrix.environment }}
      aws_region: ${{ vars.AWS_REGION }}
      terraform_version: ${{ vars.TERRAFORM_VERSION }}
      role_arn: ${{ matrix.role_arn }}
      tfstate_bucket: ${{ vars.TFSTATE_BUCKET }}
      tfstate_kms_key_arn: ${{ vars.TFSTATE_KMS_KEY_ARN }}
      state_key: ${{ matrix.state_key }}
      # NOTE: this requires your reusable plan workflow to support drift flags (e.g. -detailed-exitcode / -refresh-only)
